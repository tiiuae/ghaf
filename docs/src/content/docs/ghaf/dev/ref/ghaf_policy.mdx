---
title: Ghaf Policy Repository
---

Ghaf policies are implemented using **Rego**, the policy language of [Open Policy Agent (OPA)](https://www.openpolicyagent.org/). These policies define the security and runtime behavior of components managed by the Ghaf platform.

Policies are maintained within the policy directory at the root of the Ghaf repository, which serves as the source of for all policy logic. Initially, the focus is on USB hotplug control, with additional policy types to be introduced progressively.

## ðŸ“ Directory Structure

â”œâ”€â”€ **policies**
â””â”€â”€ **default-policy**
Â Â Â Â â”œâ”€â”€ **usb\_hotplug.rego** `Rego policy to access USB hotplug rules`

Â Â Â Â â””â”€â”€ **usb\_hotplug\_rules.json** `USB hotplug rules`

â”œâ”€â”€ **README.md**

â””â”€â”€ **tests**

Â Â Â Â â”œâ”€â”€ **opa\_server\_eval\_tests**

Â Â Â Â â”‚ â””â”€â”€ **test.sh** `Script to evaluate Rego using OPA server`

Â Â Â Â â”œâ”€â”€ **python\_eval\_tests**

Â Â Â Â â”‚ â””â”€â”€ **main.py** `Python implementation for local evaluation`

Â Â Â Â â””â”€â”€ **shell.nix** `Nix shell environment definition`

## Tests

Two types of policy evaluation tests are included:

### 1\. Python-Based Local Evaluation

This is a reference implementation of the USB policy logic in Python. It's useful for local validation and experimentation.

#### To run the Python tests:

```
$> cd tests
$> nix-shell
nix-shell $> cd python_eval_tests
nix-shell $> python main.py
```

### 2\. OPA Server-Based Evaluation

This test uses an OPA server instance to evaluate the Rego policy with sample inputs.

#### To run the OPA server evaluation tests:

```
$> cd tests
$> nix-shell
nix-shell $> cd opa_server_eval_tests
nix-shell $> bash ./test.sh
```

**Note:** Rego policies in this repository are written using Rego v1 syntax.
Make sure you are using an OPA version that is compatible with Rego v1.

## USB Hotplug Policy

This policy defines rules for securely passing through USB devices to authorized virtual machines (VMs). The core configuration is defined in JSON format, enabling local evaluation. A client can pull the policy and evaluate it locally. When local evaluation is used, the client must implement a mechanism to synchronize the policy with the OPA server.

### Features

*   Authorization rules based on USB class, subclass, and protocol
*   Denying access to specific USB devices for specific vendor/product combinations
*   Explicit rules to authorize specific USB devices (by vendor and product ID) to specific VM(s)

Detailed documentation available [here.](/ghaf/dev/ref/hotplug_policy_guide)

### Security Philosophy

The policy follows a whitelist-first approach. By default, a VM is considered unauthorized to access a USB device unless explicitly permitted by a rule. Even if a device is authorized through a general rule, its access can be overridden and denied using VM-specific blacklist entries.

## Roadmap

This repository will expand beyond USB to include policies for:

Inter-VM communication

Device access control

Authentication and authorization

and more.
