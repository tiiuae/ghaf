From 8736ddbc9db1d4ab3229ff8b21422cb37edf1db6 Mon Sep 17 00:00:00 2001
From: Yuri Nesterov <yuriy.nesterov@unikie.com>
Date: Fri, 2 May 2025 20:43:32 +0300
Subject: [PATCH] Add security context indicator

Signed-off-by: Brian McGillion <bmg.avoin@gmail.com>
---
 cosmic-comp-config/src/lib.rs         | 24 +++++++++
 src/backend/render/mod.rs             | 31 +++++++++++
 src/shell/grabs/moving.rs             | 76 ++++++++++++++++++++-------
 src/shell/layout/floating/mod.rs      | 36 +++++++++++--
 src/wayland/handlers/xdg_shell/mod.rs | 45 ++++++++++++++++
 5 files changed, 187 insertions(+), 25 deletions(-)

diff --git a/cosmic-comp-config/src/lib.rs b/cosmic-comp-config/src/lib.rs
index aa85dd2f..13c12017 100644
--- a/cosmic-comp-config/src/lib.rs
+++ b/cosmic-comp-config/src/lib.rs
@@ -81,6 +81,7 @@ pub struct CosmicCompConfig {
     /// The threshold before windows snap themselves to output edges
     pub edge_snap_threshold: u32,
     pub accessibility_zoom: ZoomConfig,
+    pub security_context: SecurityContextConfig,
 }

 impl Default for CosmicCompConfig {
@@ -116,6 +117,7 @@ impl Default for CosmicCompConfig {
             xwayland_eavesdropping: XwaylandEavesdropping::default(),
             edge_snap_threshold: 0,
             accessibility_zoom: ZoomConfig::default(),
+            security_context: SecurityContextConfig::default(),
         }
     }
 }
@@ -215,3 +217,25 @@ pub enum XwaylandDescaling {
     #[default]
     Fractional,
 }
+
+#[derive(Debug, Clone, PartialEq, Deserialize, Serialize)]
+pub struct SecurityContextRule {
+    pub app_id: String,
+    pub sandbox_engine: String,
+    pub border_color: [f32; 3],
+}
+
+#[derive(Debug, Clone, PartialEq, Deserialize, Serialize)]
+pub struct SecurityContextConfig {
+    pub border_size: u8,
+    pub rules: Vec<SecurityContextRule>,
+}
+
+impl Default for SecurityContextConfig {
+    fn default() -> SecurityContextConfig {
+        SecurityContextConfig {
+            border_size: 4,
+            rules: Vec::new(),
+        }
+    }
+}
diff --git a/src/backend/render/mod.rs b/src/backend/render/mod.rs
index 9b9faa99..deadb9db 100644
--- a/src/backend/render/mod.rs
+++ b/src/backend/render/mod.rs
@@ -128,6 +128,13 @@ pub enum Usage {
     FocusIndicator,
     PotentialGroupIndicator,
     SnappingIndicator,
+    SecurityContextIndicator,
+}
+
+#[derive(Debug, Clone, PartialEq)]
+pub struct SecurityContextIndicatorSettings {
+    pub border_color: [f32; 3],
+    pub border_size: u8,
 }

 #[derive(Clone)]
@@ -214,6 +221,30 @@ impl IndicatorShader {
         )
     }

+    pub fn focus_element_with_radius<R: AsGlowRenderer>(
+        renderer: &R,
+        key: impl Into<Key>,
+        mut element_geo: Rectangle<i32, Local>,
+        thickness: u8,
+        alpha: f32,
+        active_window_hint: [f32; 3],
+        radius: u8,
+    ) -> PixelShaderElement {
+        let t = thickness as i32;
+        element_geo.loc -= (t, t).into();
+        element_geo.size += (t * 2, t * 2).into();
+
+        IndicatorShader::element(
+            renderer,
+            key,
+            element_geo,
+            thickness,
+            [radius, radius, radius, radius],
+            alpha,
+            active_window_hint,
+        )
+    }
+
     pub fn element<R: AsGlowRenderer>(
         renderer: &R,
         key: impl Into<Key>,
diff --git a/src/shell/grabs/moving.rs b/src/shell/grabs/moving.rs
index 28939ffd..1d3ea43f 100644
--- a/src/shell/grabs/moving.rs
+++ b/src/shell/grabs/moving.rs
@@ -2,7 +2,7 @@

 use crate::{
     backend::render::{
-        BackdropShader, IndicatorShader, Key, Usage, cursor::CursorState, element::AsGlowRenderer,
+        BackdropShader, IndicatorShader, Key, Usage, cursor::CursorState, element::AsGlowRenderer, SecurityContextIndicatorSettings,
     },
     shell::{
         CosmicMapped, CosmicSurface, Direction, ManagedLayer,
@@ -47,7 +47,6 @@ use std::{
     sync::{Mutex, atomic::Ordering},
     time::Instant,
 };
-
 use super::{GrabStartData, ReleaseMode};

 pub type SeatMoveGrabState = Mutex<Option<MoveGrabState>>;
@@ -75,6 +74,7 @@ impl MoveGrabState {
         CosmicMappedRenderElement<R>: RenderElement<R>,
         I: From<CosmicMappedRenderElement<R>>,
     {
+
         let scale = if self.previous == ManagedLayer::Tiling {
             0.6 + ((1.0
                 - (Instant::now().duration_since(self.start).as_millis() as f64
@@ -108,36 +108,71 @@ impl MoveGrabState {
             + self.window_offset
             - scaling_offset;

+        let mut secctx_element = None;
+        let mut secctx_border_size = 0;
+        if self.window.is_window() {
+            let surface = self.window.active_window();
+            if let Some(secctx_settings) = surface.user_data().get::<SecurityContextIndicatorSettings>() {
+                secctx_border_size = secctx_settings.border_size;
+                secctx_element = Some(
+                    CosmicMappedRenderElement::from(IndicatorShader::focus_element(
+                        renderer,
+                        Key::Window(Usage::SecurityContextIndicator, self.window.key()),
+                        Rectangle::new(
+                            render_location,
+                            self.window
+                                .geometry()
+                                .size
+                                .to_f64()
+                                .upscale(scale)
+                                .to_i32_round(),
+                        )
+                        .as_local(),
+                        secctx_settings.border_size,
+                        [secctx_settings.border_size, secctx_settings.border_size, secctx_settings.border_size, secctx_settings.border_size],
+                        alpha,
+                        secctx_settings.border_color,
+                    ))
+                    .into(),
+                );
+            }
+        }
+
         let active_window_hint = crate::theme::active_window_hint(theme);
-        let radius = self
-            .element()
-            .corner_radius(window_geo.size, self.indicator_thickness);

         let focus_element = if self.indicator_thickness > 0 {
-            Some(CosmicMappedRenderElement::from(
-                IndicatorShader::focus_element(
+            let mut indicator_geometry = Rectangle::new(
+                render_location,
+                self.window
+                    .geometry()
+                    .size
+                    .to_f64()
+                    .upscale(scale)
+                    .to_i32_round(),
+            ).as_local();
+            let mut radius = self.indicator_thickness * 2;
+            if secctx_border_size > self.indicator_thickness {
+                let size = (secctx_border_size - self.indicator_thickness) as i32;
+                indicator_geometry.loc -= (size, size).into();
+                indicator_geometry.size += (size * 2, size * 2).into();
+                radius = secctx_border_size as u8 * 2;
+            }
+            Some(
+                CosmicMappedRenderElement::from(IndicatorShader::focus_element_with_radius(
                     renderer,
                     Key::Window(Usage::MoveGrabIndicator, self.window.key()),
-                    Rectangle::new(
-                        render_location,
-                        self.window
-                            .geometry()
-                            .size
-                            .to_f64()
-                            .upscale(scale)
-                            .to_i32_round(),
-                    )
-                    .as_local(),
+                    indicator_geometry,
                     self.indicator_thickness,
-                    radius,
                     alpha,
                     [
                         active_window_hint.red,
                         active_window_hint.green,
                         active_window_hint.blue,
                     ],
-                ),
-            ))
+                    radius,
+                ))
+                .into(),
+            )
         } else {
             None
         };
@@ -218,6 +253,7 @@ impl MoveGrabState {
             })
             .chain(p_elements)
             .chain(focus_element)
+            .chain(secctx_element)
             .chain(w_elements.into_iter().map(|elem| match elem {
                 CosmicMappedRenderElement::Stack(stack) => {
                     CosmicMappedRenderElement::GrabbedStack(
diff --git a/src/shell/layout/floating/mod.rs b/src/shell/layout/floating/mod.rs
index ae29e604..6c7c37cf 100644
--- a/src/shell/layout/floating/mod.rs
+++ b/src/shell/layout/floating/mod.rs
@@ -24,7 +24,7 @@ use smithay::{
 };

 use crate::{
-    backend::render::{IndicatorShader, Key, Usage, element::AsGlowRenderer},
+    backend::render::{IndicatorShader, Key, Usage, element::AsGlowRenderer, SecurityContextIndicatorSettings},
     shell::{
         CosmicSurface, Direction, ManagedLayer, MoveResult, ResizeMode,
         element::{
@@ -1558,6 +1558,25 @@ impl FloatingLayout {
                     .collect();
             }

+            // Security context indicator
+            let mut secctx_border_size = 0;
+            if elem.is_window() {
+                let surface = elem.active_window();
+                if let Some(secctx_settings) = surface.user_data().get::<SecurityContextIndicatorSettings>() {
+                    secctx_border_size = secctx_settings.border_size;
+                    let element = IndicatorShader::focus_element(
+                        renderer,
+                        Key::Window(Usage::SecurityContextIndicator, elem.key()),
+                        geometry,
+                        secctx_settings.border_size,
+                        [secctx_settings.border_size, secctx_settings.border_size, secctx_settings.border_size, secctx_settings.border_size],
+                        alpha,
+                        secctx_settings.border_color,
+                    );
+                    window_elements.insert(0, element.into());
+                }
+            }
+
             if focused == Some(elem) && !elem.is_maximized(false) {
                 if let Some((mode, resize)) = resize_indicator.as_mut() {
                     let mut resize_geometry = geometry;
@@ -1583,20 +1602,27 @@ impl FloatingLayout {
                 }

                 let active_window_hint = crate::theme::active_window_hint(theme);
-                let radius = elem.corner_radius(geometry.size.as_logical(), indicator_thickness);
                 if indicator_thickness > 0 {
-                    let element = IndicatorShader::focus_element(
+                    let mut indicator_geometry = geometry.clone();
+                    let mut radius = indicator_thickness * 2;
+                    if secctx_border_size > indicator_thickness {
+                        let size = (secctx_border_size - indicator_thickness) as i32;
+                        indicator_geometry.loc -= (size, size).into();
+                        indicator_geometry.size += (size * 2, size * 2).into();
+                        radius = secctx_border_size as u8 * 2;
+                    }
+                    let element = IndicatorShader::focus_element_with_radius(
                         renderer,
                         Key::Window(Usage::FocusIndicator, elem.key()),
-                        geometry,
+                        indicator_geometry,
                         indicator_thickness,
-                        radius,
                         alpha,
                         [
                             active_window_hint.red,
                             active_window_hint.green,
                             active_window_hint.blue,
                         ],
+                        radius,
                     );
                     window_elements.insert(0, element.into());
                 }
diff --git a/src/wayland/handlers/xdg_shell/mod.rs b/src/wayland/handlers/xdg_shell/mod.rs
index 56efd92e..955ef4ad 100644
--- a/src/wayland/handlers/xdg_shell/mod.rs
+++ b/src/wayland/handlers/xdg_shell/mod.rs
@@ -3,6 +3,8 @@
 use crate::{
     shell::{CosmicSurface, PendingWindow, focus::target::KeyboardFocusTarget, grabs::ReleaseMode},
     utils::prelude::*,
+    state::ClientState,
+    backend::render::SecurityContextIndicatorSettings,
 };
 use smithay::desktop::layer_map_for_output;
 use smithay::{
@@ -16,6 +18,7 @@ use smithay::{
     reexports::{
         wayland_protocols::xdg::shell::server::xdg_toplevel,
         wayland_server::protocol::{wl_output::WlOutput, wl_seat::WlSeat},
+        wayland_server::Resource,
     },
     utils::{Logical, Point, Serial},
     wayland::{
@@ -44,7 +47,49 @@ impl XdgShellHandler for State {
     fn new_toplevel(&mut self, surface: ToplevelSurface) {
         let mut shell = self.common.shell.write();
         let seat = shell.seats.last_active().clone();
+
         let window = CosmicSurface::from(surface);
+
+        // Get security context data
+        if let Some(client) = window.wl_surface().unwrap().client() {
+            let client_data = self
+                .common
+                .display_handle
+                .backend_handle()
+                .get_client_data(client.id().clone())
+                .ok();
+
+            if let Some(security_context) = client_data
+                .as_ref()
+                .and_then(|data| data.downcast_ref::<ClientState>())
+                .and_then(|data| data.security_context.as_ref()) {
+
+                // Try to find a security context rule by sandbox engine and appid
+                let sandbox_engine = security_context
+                    .sandbox_engine
+                    .as_deref()
+                    .unwrap_or_default();
+                let app_id = security_context.app_id.as_deref().unwrap_or_default();
+                let border_color = self
+                    .common.config.cosmic_conf.security_context.rules
+                    .iter()
+                    .find(|config| {
+                        config.sandbox_engine == sandbox_engine && config.app_id == app_id
+                    })
+                    .map(|config| config.border_color.clone());
+
+                if let Some(color) = border_color {
+
+                    // Add security context indicator settings to the user data
+                    let indicator = SecurityContextIndicatorSettings {
+                        border_color: color,
+                        border_size: self.common.config.cosmic_conf.security_context.border_size,
+                    };
+                    window.user_data().get_or_insert_threadsafe(|| indicator.clone());
+                }
+            }
+        }
+
         shell.pending_windows.push(PendingWindow {
             surface: window,
             seat,
--
2.51.0
