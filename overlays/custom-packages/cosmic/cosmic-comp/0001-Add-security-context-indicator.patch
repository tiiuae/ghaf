From a30eafe28f638078c6f4f919ed90ebb67b5a676a Mon Sep 17 00:00:00 2001
From: Yuri Nesterov <yuriy.nesterov@unikie.com>
Date: Fri, 2 May 2025 20:43:32 +0300
Subject: [PATCH] Add security context indicator

---
 cosmic-comp-config/src/lib.rs         | 24 +++++++++
 src/backend/render/mod.rs             |  7 +++
 src/shell/grabs/moving.rs             | 75 +++++++++++++++++++++------
 src/shell/layout/floating/mod.rs      | 36 +++++++++++--
 src/wayland/handlers/xdg_shell/mod.rs | 42 +++++++++++++++
 5 files changed, 165 insertions(+), 19 deletions(-)

diff --git a/cosmic-comp-config/src/lib.rs b/cosmic-comp-config/src/lib.rs
index 6063d476..43c5bccf 100644
--- a/cosmic-comp-config/src/lib.rs
+++ b/cosmic-comp-config/src/lib.rs
@@ -99,6 +99,7 @@ pub struct CosmicCompConfig {
     pub edge_snap_threshold: u32,
     pub accessibility_zoom: ZoomConfig,
     pub appearance_settings: AppearanceConfig,
+    pub security_context: SecurityContextConfig,
 }
 
 impl Default for CosmicCompConfig {
@@ -135,6 +136,7 @@ impl Default for CosmicCompConfig {
             edge_snap_threshold: 0,
             accessibility_zoom: ZoomConfig::default(),
             appearance_settings: AppearanceConfig::default(),
+            security_context: SecurityContextConfig::default(),
         }
     }
 }
@@ -234,3 +236,25 @@ pub enum XwaylandDescaling {
     #[default]
     Fractional,
 }
+
+#[derive(Debug, Clone, PartialEq, Deserialize, Serialize)]
+pub struct SecurityContextRule {
+    pub app_id: String,
+    pub sandbox_engine: String,
+    pub border_color: [f32; 3],
+}
+
+#[derive(Debug, Clone, PartialEq, Deserialize, Serialize)]
+pub struct SecurityContextConfig {
+    pub border_size: u8,
+    pub rules: Vec<SecurityContextRule>,
+}
+
+impl Default for SecurityContextConfig {
+    fn default() -> SecurityContextConfig {
+        SecurityContextConfig {
+            border_size: 4,
+            rules: Vec::new(),
+        }
+    }
+}
diff --git a/src/backend/render/mod.rs b/src/backend/render/mod.rs
index c7d79967..cb7ee466 100644
--- a/src/backend/render/mod.rs
+++ b/src/backend/render/mod.rs
@@ -137,6 +137,13 @@ pub enum Usage {
     PotentialGroupIndicator,
     SnappingIndicator,
     Border,
+    SecurityContextIndicator,
+}
+
+#[derive(Debug, Clone, PartialEq)]
+pub struct SecurityContextIndicatorSettings {
+    pub border_color: [f32; 3],
+    pub border_size: u8,
 }
 
 #[derive(Clone)]
diff --git a/src/shell/grabs/moving.rs b/src/shell/grabs/moving.rs
index f59f93d6..35ef8ba7 100644
--- a/src/shell/grabs/moving.rs
+++ b/src/shell/grabs/moving.rs
@@ -2,7 +2,7 @@
 
 use crate::{
     backend::render::{
-        BackdropShader, IndicatorShader, Key, Usage, cursor::CursorState, element::AsGlowRenderer,
+        BackdropShader, IndicatorShader, Key, Usage, cursor::CursorState, element::AsGlowRenderer, SecurityContextIndicatorSettings
     },
     shell::{
         CosmicMapped, CosmicSurface, Direction, ManagedLayer,
@@ -108,26 +108,67 @@ impl MoveGrabState {
             + self.window_offset
             - scaling_offset;
 
+        // Security context indicator
+        let mut secctx_element = None;
+        let mut secctx_border_size = 0;
+        if self.window.is_window() {
+            let surface = self.window.active_window();
+            if let Some(secctx_settings) = surface.user_data().get::<SecurityContextIndicatorSettings>() {
+                secctx_border_size = secctx_settings.border_size;
+                let radius = self.element().corner_radius(window_geo.size, secctx_border_size);
+                secctx_element = Some(
+                    CosmicMappedRenderElement::from(IndicatorShader::focus_element(
+                        renderer,
+                        Key::Window(Usage::SecurityContextIndicator, self.window.key()),
+                        Rectangle::new(
+                            render_location,
+                            self.window
+                                .geometry()
+                                .size
+                                .to_f64()
+                                .upscale(scale)
+                                .to_i32_round(),
+                        )
+                        .as_local(),
+                        secctx_border_size,
+                        radius,
+                        alpha,
+                        output_scale.x,
+                        secctx_settings.border_color,
+                    ))
+                    .into(),
+                );
+            }
+        }
+
         let active_window_hint = crate::theme::active_window_hint(theme);
-        let radius = self
+        let mut radius = self
             .element()
             .corner_radius(window_geo.size, self.indicator_thickness);
 
         let focus_element = if self.indicator_thickness > 0 {
-            Some(CosmicMappedRenderElement::from(
-                IndicatorShader::focus_element(
+            let mut indicator_geometry = Rectangle::new(
+                render_location,
+                self.window
+                    .geometry()
+                    .size
+                    .to_f64()
+                    .upscale(scale)
+                    .to_i32_round(),
+            ).as_local();
+            if secctx_border_size > 0 {
+                let offset = secctx_border_size as i32;
+                indicator_geometry.loc -= (offset, offset).into();
+                indicator_geometry.size += (offset * 2, offset * 2).into();
+                for r in &mut radius {
+                   *r += offset as u8;
+                }
+            }
+            Some(
+                CosmicMappedRenderElement::from(IndicatorShader::focus_element(
                     renderer,
                     Key::Window(Usage::MoveGrabIndicator, self.window.key()),
-                    Rectangle::new(
-                        render_location,
-                        self.window
-                            .geometry()
-                            .size
-                            .to_f64()
-                            .upscale(scale)
-                            .to_i32_round(),
-                    )
-                    .as_local(),
+                    indicator_geometry,
                     self.indicator_thickness,
                     radius,
                     alpha,
@@ -137,8 +178,9 @@ impl MoveGrabState {
                         active_window_hint.green,
                         active_window_hint.blue,
                     ],
-                ),
-            ))
+                ))
+                .into(),
+            )
         } else {
             None
         };
@@ -229,6 +271,7 @@ impl MoveGrabState {
             })
             .chain(p_elements)
             .chain(focus_element)
+            .chain(secctx_element)
             .chain(
                 w_elements
                     .into_iter()
diff --git a/src/shell/layout/floating/mod.rs b/src/shell/layout/floating/mod.rs
index 1f3a7334..c047743e 100644
--- a/src/shell/layout/floating/mod.rs
+++ b/src/shell/layout/floating/mod.rs
@@ -25,7 +25,7 @@ use smithay::{
 };
 
 use crate::{
-    backend::render::{IndicatorShader, Key, Usage, element::AsGlowRenderer},
+    backend::render::{IndicatorShader, Key, Usage, element::AsGlowRenderer, SecurityContextIndicatorSettings},
     shell::{
         CosmicSurface, Direction, ManagedLayer, MoveResult, ResizeMode,
         element::{
@@ -1590,6 +1590,27 @@ impl FloatingLayout {
                     .collect();
             }
 
+            // Security context indicator
+            let mut secctx_border_size = 0;
+            if elem.is_window() {
+                let surface = elem.active_window();
+                if let Some(secctx_settings) = surface.user_data().get::<SecurityContextIndicatorSettings>() {
+                    secctx_border_size =  secctx_settings.border_size;
+                    let radius = elem.corner_radius(geometry.size.as_logical(), secctx_border_size);
+                    let element = IndicatorShader::focus_element(
+                        renderer,
+                        Key::Window(Usage::SecurityContextIndicator, elem.key()),
+                        geometry,
+                        secctx_border_size,
+                        radius,
+                        alpha,
+                        output_scale,
+                        secctx_settings.border_color,
+                    );
+                    window_elements.insert(0, element.into());
+                }
+            }
+
             if focused == Some(elem) && !elem.is_maximized(false) {
                 if let Some((mode, resize)) = resize_indicator.as_mut() {
                     let mut resize_geometry = geometry;
@@ -1615,12 +1636,21 @@ impl FloatingLayout {
                 }
 
                 let active_window_hint = crate::theme::active_window_hint(theme);
-                let radius = elem.corner_radius(geometry.size.as_logical(), indicator_thickness);
+                let mut radius = elem.corner_radius(geometry.size.as_logical(), indicator_thickness);
                 if indicator_thickness > 0 {
+                    let mut indicator_geometry = geometry.clone();
+                    if secctx_border_size > 0 {
+                        let offset = secctx_border_size as i32;
+                        indicator_geometry.loc -= (offset, offset).into();
+                        indicator_geometry.size += (offset * 2, offset * 2).into();
+                        for r in &mut radius {
+                            *r += offset as u8;
+                        }
+                    }
                     let element = IndicatorShader::focus_element(
                         renderer,
                         Key::Window(Usage::FocusIndicator, elem.key()),
-                        geometry,
+                        indicator_geometry,
                         indicator_thickness,
                         radius,
                         alpha,
diff --git a/src/wayland/handlers/xdg_shell/mod.rs b/src/wayland/handlers/xdg_shell/mod.rs
index 43e6a46d..dcf69aca 100644
--- a/src/wayland/handlers/xdg_shell/mod.rs
+++ b/src/wayland/handlers/xdg_shell/mod.rs
@@ -3,6 +3,8 @@
 use crate::{
     shell::{CosmicSurface, PendingWindow, focus::target::KeyboardFocusTarget, grabs::ReleaseMode},
     utils::prelude::*,
+    state::ClientState,
+    backend::render::SecurityContextIndicatorSettings,
 };
 use smithay::desktop::layer_map_for_output;
 use smithay::{
@@ -16,6 +18,7 @@ use smithay::{
     reexports::{
         wayland_protocols::xdg::shell::server::xdg_toplevel,
         wayland_server::protocol::{wl_output::WlOutput, wl_seat::WlSeat},
+        wayland_server::Resource,
     },
     utils::{Logical, Point, Serial},
     wayland::{
@@ -45,6 +48,45 @@ impl XdgShellHandler for State {
         let mut shell = self.common.shell.write();
         let seat = shell.seats.last_active().clone();
         let window = CosmicSurface::from(surface);
+
+        // Get security context data
+        if let Some(client) = window.wl_surface().unwrap().client() {
+            let client_data = self
+                .common
+                .display_handle
+                .backend_handle()
+                .get_client_data(client.id().clone())
+                .ok();
+
+            if let Some(security_context) = client_data
+                .as_ref()
+                .and_then(|data| data.downcast_ref::<ClientState>())
+                .and_then(|data| data.security_context.as_ref()) {
+                // Try to find a security context rule by sandbox engine and appid
+                let sandbox_engine = security_context
+                    .sandbox_engine
+                    .as_deref()
+                    .unwrap_or_default();
+                let app_id = security_context.app_id.as_deref().unwrap_or_default();
+                let border_color = self
+                    .common.config.cosmic_conf.security_context.rules
+                    .iter()
+                    .find(|config| {
+                        config.sandbox_engine == sandbox_engine && config.app_id == app_id
+                    })
+                    .map(|config| config.border_color.clone());
+
+                if let Some(color) = border_color {
+                    // Add security context indicator settings to the user data
+                    let indicator = SecurityContextIndicatorSettings {
+                        border_color: color,
+                        border_size: self.common.config.cosmic_conf.security_context.border_size,
+                    };
+                    window.user_data().get_or_insert_threadsafe(|| indicator.clone());
+                }
+            }
+        }
+
         shell.pending_windows.push(PendingWindow {
             surface: window,
             seat,
-- 
2.43.0

