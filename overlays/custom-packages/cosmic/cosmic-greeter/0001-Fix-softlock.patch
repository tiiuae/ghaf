From ecaade5d43a11803dd867915d17230b378e1ff05 Mon Sep 17 00:00:00 2001
From: Kajus Naujokaitis <kajus.naujokaitis@unikie.com>
Date: Fri, 12 Dec 2025 11:49:08 +0200
Subject: [PATCH] fix: prevent softlock via auth_message_type error

Signed-off-by: Kajus Naujokaitis <kajus.naujokaitis@unikie.com>
---
 src/common.rs      | 13 ++++++++++++-
 src/greeter/ipc.rs |  7 ++++---
 src/locker.rs      | 22 ++++++++++++++++++++--
 3 files changed, 36 insertions(+), 6 deletions(-)

diff --git a/src/common.rs b/src/common.rs
index 724d7ed..c2bb35f 100644
--- a/src/common.rs
+++ b/src/common.rs
@@ -296,8 +296,19 @@ impl<M: From<Message> + Send + 'static> Common<M> {
                     .map(|(name, level)| (widget::icon::from_name(name).into(), level));
             }
             Message::Prompt(prompt, secret, value_opt) => {
+                let mut new_value_opt = value_opt;
+
+                let should_clear =
+                    self.prompt_opt
+                        .as_ref()
+                        .map(|(prev_prompt, _, _)| prev_prompt != &prompt)
+                        .unwrap_or(true);
+
+                if should_clear {
+                    new_value_opt = Some(String::new());
+                }
                 let prompt_was_none = self.prompt_opt.is_none();
-                self.prompt_opt = Some((prompt, secret, value_opt));
+                self.prompt_opt = Some((prompt, secret, new_value_opt));
                 if prompt_was_none {
                     if let Some(surface_id) = self.active_surface_id_opt {
                         if let Some(text_input_id) = self
diff --git a/src/greeter/ipc.rs b/src/greeter/ipc.rs
index c6e070d..ff930af 100644
--- a/src/greeter/ipc.rs
+++ b/src/greeter/ipc.rs
@@ -101,9 +101,7 @@ pub fn subscription() -> Subscription<Message> {
                                             )
                                             .await;
                                     }
-                                    //TODO: treat error type differently?
-                                    greetd_ipc::AuthMessageType::Info
-                                    | greetd_ipc::AuthMessageType::Error => {
+                                    greetd_ipc::AuthMessageType::Info => {
                                         _ = sender
                                             .send(
                                                 common::Message::Prompt(auth_message, false, None)
@@ -111,6 +109,9 @@ pub fn subscription() -> Subscription<Message> {
                                             )
                                             .await;
                                     }
+                                    greetd_ipc::AuthMessageType::Error => {
+                                        _ = sender.send(Message::Error(auth_message)).await;
+                                    }
                                 },
                                 greetd_ipc::Response::Error {
                                     error_type,
diff --git a/src/locker.rs b/src/locker.rs
index 7c147c0..4fa6a28 100644
--- a/src/locker.rs
+++ b/src/locker.rs
@@ -202,6 +202,25 @@ impl Conversation {
             pam_client::ErrorCode::CONV_ERR
         })
     }
+
+    fn error_message(&mut self, prompt_c: &CStr) -> Result<(), pam_client::ErrorCode> {
+        let prompt = prompt_c.to_str().map_err(|err| {
+            tracing::error!("failed to convert prompt to UTF-8: {:?}", err);
+            pam_client::ErrorCode::CONV_ERR
+        })?;
+
+        futures::executor::block_on(async {
+            self.msg_tx
+                .send(cosmic::Action::App(
+                    Message::Error(prompt.to_string()).into(),
+                ))
+                .await
+        })
+        .map_err(|err| {
+            tracing::error!("failed to send error message: {:?}", err);
+            pam_client::ErrorCode::CONV_ERR
+        })
+    }
 }

 impl pam_client::ConversationHandler for Conversation {
@@ -223,9 +242,8 @@ impl pam_client::ConversationHandler for Conversation {
         }
     }
     fn error_msg(&mut self, prompt_c: &CStr) {
-        //TODO: treat error type differently?
         tracing::info!("error_msg {:?}", prompt_c);
-        match self.message(prompt_c) {
+        match self.error_message(prompt_c) {
             Ok(()) => (),
             Err(err) => {
                 tracing::warn!("failed to send error_msg: {:?}", err);
--
2.51.2

